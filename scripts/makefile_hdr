#a Copyright
#  
#  This file 'makefile_hdr' copyright Gavin J Stark 2003, 2004
#  
#  This is free software; you can redistribute it and/or modify it however you wish,
#  with no obligations
#  
#  This software is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even implied warranty of MERCHANTABILITY
#  or FITNESS FOR A PARTICULAR PURPOSE.

#a Documentation - This file is included in the CDL build system only
PREREQS ?= 
# $(PREREQS) should be a list of letters including:
#   b if backend includes are required
#   e if simulation engine includes are required
#   s if support includes are required
#   h if execution harness includes are required
#   i if exported includes are required
#   B if backend objects are required
#   E if simulation engine objects are required
#   S if support libraries are required
#   H if execution harness objects are required

#a Determine OS subdirectories - required for includes and objects for builds
objs_from_srcs = $(foreach SRC,${1},$(patsubst %.cpp,${OS_DIR}/%.o,${SRC:.y=.cpp}))

ifneq (${BUILD_PYTHON},yes)
BUILD_PYTHON = no
# $(info Building without python bindings)
else
# $(info Building with python bindings)
endif
ifneq (${BUILD_VPI},yes)
BUILD_VPI = no
endif

#a Set up correct includes and objects for builds
CYCLICITY_INCLUDES    = -I ${CDL_BUILD_INCLUDE_DIR}
CYCLICITY_LIBS        = -L ${CDL_BUILD_LIB_DIR} 
CYCLICITY_LIBS_PYTHON = -L ${CDL_BUILD_LIB_DIR} 

BACKEND_INCLUDES :=
ENGINE_INCLUDES :=
SUPPORT_INCLUDES := 
HARNESS_INCLUDES := 
BACKEND_OBJECTS :=
ENGINE_LIBS :=
ENGINE_OBJECTS :=
SUPPORT_OBJECTS := 
SUPPORT_LIBS :=
HARNESS_BATCH_OBJECTS := 
HARNESS_GUI_OBJECTS := 

ifneq (,$(findstring s,${PREREQS}))
endif
ifneq (,$(findstring S,${PREREQS}))
CYCLICITY_LIBS        += -lcdl_sl
CYCLICITY_LIBS_PYTHON += -lcdl_sl_python
SUPPORT_LIBS := -lpthread
endif

ifneq (,$(findstring b,${PREREQS}))
CYCLICITY_INCLUDES  += -I ${CDL_SRC_ROOT}/backend
endif
ifneq (,$(findstring B,${PREREQS}))
CYCLICITY_INCLUDES     += -I ${CDL_SRC_ROOT}/backend
CYCLICITY_LIBS         += ${CDL_BUILD_OBJ_DIR}/be_backend.o
CYCLICITY_LIBS_PYTHON  += ${CDL_BUILD_OBJ_DIR}/be_backend.o
endif

ifneq (,$(findstring e,${PREREQS}))
CYCLICITY_INCLUDES  += -I ${CDL_SRC_ROOT}/simulation_engine
endif
ifneq (,$(findstring E,${PREREQS}))
CYCLICITY_INCLUDES  += -I ${CDL_SRC_ROOT}/simulation_engine
endif

ifneq (,$(findstring h,${PREREQS}))
HARNESS_INCLUDES := -I ${CDL_SRC_ROOT}/execution_harnesses
endif
ifneq (,$(findstring H,${PREREQS}))
HARNESS_INCLUDES := -I ${CDL_SRC_ROOT}/execution_harnesses
endif

#a Resultant 'libraries'
SUPPORT_PLAIN_LIBRARY   := libcdl_sl.a
SUPPORT_PYTHON_LIBRARY  := libcdl_sl_python.a
SIMULATION_LIBRARY         := libcdl_se_no_harness.a
SIMULATION_LIBRARY_BATCH   := libcdl_se_batch.a
SIMULATION_LIBRARY_PYTHON  := libcdl_se_python.a
ifeq (${BUILD_PYTHON},no)
SUPPORT_PYTHON_LIBRARY    := python_is_not_configured
SIMULATION_LIBRARY_PYTHON := python_is_not_configured
endif

#a Default linux environment
# Use '=' here as SPECIFIC_INCLUDES is set AFTER this file is included
BUILD_FLAGS = ${CONFIG_OPTIMIZATION_FLAGS}

LIBS = 
LIB_DEP_EXT = so
LIB_EXT = so

#a Makefile flags
# for verbose builds use Q:=
Q:=@

#a Compiler flags
COMPILE_OPTIMIZATION_FLAGS := -O2 -Wall
LINK_OPTIMIZATION_FLAGS := 
ifeq (${DEBUG_BUILD},yes)
	COMPILE_OPTIMIZATION_FLAGS := -DDEBUG_ENABLED -g -Wall
	LINK_OPTIMIZATION_FLAGS := -g
endif

CFLAGS   = ${COMPILE_OPTIMIZATION_FLAGS} ${CYCLICITY_INCLUDES} ${SPECIFIC_INCLUDES} ${OS_CFLAGS}    ${LOCAL_CFLAGS}
CXXFLAGS = ${COMPILE_OPTIMIZATION_FLAGS} ${CYCLICITY_INCLUDES} ${SPECIFIC_INCLUDES} ${OS_CXXFLAGS}  ${LOCAL_CXXFLAGS}
LINKFLAGS = ${LINK_OPTIMIZATION_FLAGS} -L${CDL_BUILD_LIB_DIR}                 ${OS_LINKFLAGS} ${LOCAL_LINKFLAGS}

#a Os-specific overrides - libs for python and DLL generation issues
ifndef PYTHON_ROOT
  PYTHON_ROOT := /usr
endif

#a Default patterns
${OS_DIR}/%.o : %.cpp
	@echo "CC $< -o $@"
	$(Q)$(CC) -c ${CXXFLAGS} -Wp,-MD,${OS_DIR}/$*.P $< -o $@

#a Install
.PHONY: install install_include install_bin install_lib install_script install_python
install: install_include install_bin install_lib install_script install_python

#a Templates
#f make_static_library
define make_static_library
# @param $1 library filename
# @param $2 objects
# @param $3 static libraries to include in addition - must be ${CDL_BUILD_LIB_DIR}/lib<x>.a

$1:$2
	@echo "make static library $$@"
	${Q}${MAKE_STATIC_LIBRARY} $$@ $2 $(foreach l,$3,${CDL_BUILD_LIB_DIR}/lib$l.a)

endef

#f install_static_library - installs in lib (from CDL_BUILD_LIB_DIR)
define install_static_library
# @param $1 library name (must be built as ${CDL_BUILD_LIB_DIR}/$1)

install_bin: install__$1

# Use INSTALL_DATA as it does not strip the library - that would make it uselss
install__$1: ${CDL_BUILD_LIB_DIR}/$1
	@echo "install static library $1"
	${Q} [ -d ${INSTALL_LIB_DIR} ] || mkdir -p ${INSTALL_LIB_DIR}
	${Q}${INSTALL_DATA} $$< ${INSTALL_LIB_DIR}

endef

#f make_static_binary
define make_static_binary
# @param $1 binary filename
# @param $2 objects
# @param $3 libraries

$1:$2
	@echo "make static binary $$@"
	${Q}${MAKE_STATIC_BINARY} $$@ $2 $3

endef

#f install_static_binary - installs in bin (from CDL_BUILD_BIN_DIR)
define install_static_binary
# @param $1 binary name (must be built in to ${CDL_BUILD_BIN_DIR}/$1

install_bin: install__$1

install__$1: ${CDL_BUILD_BIN_DIR}/$1
	@echo "install static binary $1"
	${Q} [ -d ${INSTALL_BIN_DIR} ] || mkdir -p ${INSTALL_BIN_DIR}
	${Q}${INSTALL_PROGRAM} $$< ${INSTALL_BIN_DIR}

endef

#f install_script - installs in libexec/cdl normally (from CDL_SCRIPTS_DIR)
define install_script
# @param $1 script filename - should be in ${CDL_SCRIPTS_DIR}
install_script: install__$1

install__$1: ${CDL_SCRIPTS_DIR}/$1
	@echo "install script $1"
	${Q} [ -d ${INSTALL_SCRIPT_DIR} ] || mkdir -p ${INSTALL_SCRIPT_DIR}
	${Q}${INSTALL_SCRIPT} $$< ${INSTALL_SCRIPT_DIR}

endef

#f install_bin_script - installs in bin normally (from CDL_SCRIPTS_DIR)
define install_bin_script
# @param $1 executable filename - should be in ${CDL_SCRIPTS_DIR}
install_script: install__$1

install__$1: ${CDL_SCRIPTS_DIR}/$1
	@echo "install binary script $1"
	${Q} [ -d ${INSTALL_BIN_DIR} ] || mkdir -p ${INSTALL_BIN_DIR}
	${Q}${INSTALL_SCRIPT} $$< ${INSTALL_BIN_DIR}

endef

#f install_data - installs in lib/cdl normally (from CDL_SCRIPTS_DIR)
define install_data
# @param $1 executable filename - should be in ${CDL_SCRIPTS_DIR}
install_script: install__$1

install__$1: ${CDL_SCRIPTS_DIR}/$1
	@echo "install data script $1"
	${Q} [ -d ${INSTALL_DATA_DIR} ] || mkdir -p ${INSTALL_DATA_DIR}
	${Q}${INSTALL_DATA} $$< ${INSTALL_DATA_DIR}

endef

#f add_include
define add_include
# @param $1 include filename

include: ${CDL_BUILD_INCLUDE_DIR}/$1

${CDL_BUILD_INCLUDE_DIR}/$1: $1
	@echo "cp include $1" 
	${Q}cp $$< $$@

install_include: install__$1

install__$1: ${CDL_BUILD_INCLUDE_DIR}/$1
	@echo "install include $1"
	${Q} [ -d ${INSTALL_HDRS_DIR} ] || mkdir -p ${INSTALL_HDRS_DIR}
	${Q}${INSTALL_DATA} $$< ${INSTALL_HDRS_DIR}

endef

#f add_includes
#
# Add a list of includes
#
# @param $1	includes
#
define add_includes
$(foreach x,$1,$(eval $(call add_include,$x)))
endef

#f add_python_file
define add_python_file
# @param $1 python filename - to be installed from local directory to INSTALL_PYTHON_DIR

install_python: install__py__$1

install__py__$1: $1
	@echo "install python file $1"
	${Q} [ -d ${INSTALL_PYTHON_DIR} ] || mkdir -p ${INSTALL_PYTHON_DIR}
	${Q}${INSTALL_DATA} $$< ${INSTALL_PYTHON_DIR}

endef

#f add_python_files
#
# Add a list of python files
#
# @param $1	python files
#
define add_python_files
$(foreach x,$1,$(eval $(call add_python_file,$x)))
endef

#f new_stamp
#
# Define a new makefile stamp
#
# @param $1	stamp name
#
define new_stamp

MK_$1 := ${CDL_BUILD_STAMPS_DIR}/$1

.PHONY: $1

$1: $$(MK_$$1)

endef

